# How to set up an Ubuntu 20.04 system for the daily builds



## 1. Initial setup (from a sudoer account)


Everything in this section must be done **from a sudoer account**.


### 1.1 Standalone vs non-standalone builder

The machine could either be configured as a _standalone_ builder or as
a _non-standalone_ builder. A _non-standalone_ builder is a build node that
participates to builds run by a group of build machines. For example,
3 machines participated to the BioC 3.11 software builds:
https://bioconductor.org/checkResults/3.11/bioc-LATEST/

When part of a group of build machines, one machine must be setup as the
_central_ builder (a.k.a. _primary node_) e.g. malbec2 in the case of the
BioC 3.11 software builds. All the other machines (called _secondary nodes_)
must be able to communicate (SSH and HTTP/S) with the central builder.
Note that this communication generates some fair amount of data transfer
back and forth between each secondary node and the central builder (> 5GB
every day on normal days).


### 1.2 Check hardware requirements

These are the requirements for running the BioC software builds.

For a _central_ builder:

- At least 800GB of disk space

- At least 32 logical cores

- At least 48GB of RAM

For a _secondary node_ or _standalone_ builder:

- At least 400GB of disk space

- At least 20 logical cores

- At least 32GB of RAM

These requirements are _very_ approximate and tend to increase over time (as
Bioconductor grows). The above numbers reflect the current state of affairs
as of Aug 2020.


### 1.3 Check /etc/hostname and /etc/hosts

- `/etc/hostname` should contain the short name of the build
  machine as it will appear on the build report (e.g. `nebbiolo2`).
  Note that you will need to make sure to set `BBS_NODE_HOSTNAME`
  to the same value when you configure BBS (see for example
  `3.14/bioc/nebbiolo2/config.sh` in BBS git tree).

- Check `/etc/hosts` and make sure that it contains an entry that maps
  the name in `/etc/hostname` to 127.0.1.1 or to the permanent IP address
  of the machine.

TESTING: You should be able to ping yourself with e.g.:

    ping nebbiolo2

Note that not having this set properly will cause Bioconductor package RGMQL
to fail. So if the software builds are already set up, you can start R from
the biocbuild account and also try:

    library(RGMQL)
    init_gmql()  # will fail if the short name of the machine
                 # does not resolve to itself


### 1.4 Apply any pending system updates and reboot

#### Quick way:

    sudo apt-get update && sudo apt-get --with-new-pkgs upgrade && sudo apt autoremove
    sudo reboot

#### Not so quick way:

This "not so quick way" might require up to 5 calls to `sudo apt-get upgrade`!

- Let's start with the basic commands:
    ```
    sudo apt-get update
    sudo apt-get upgrade  # 1st time
    ```

- Then try `sudo apt-get upgrade` again (2nd time) to see if more actions are
  needed. It should display something like:
    ```
    0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
    ```
  But if it displays something like:
    ```
    ...
    The following packages have been kept back:
      base-files linux-headers-generic netplan.io ubuntu-server
    0 upgraded, 0 newly installed, 0 to remove and 4 not upgraded.
    ```
  then upgrade again with:
    ```
    sudo apt-get --with-new-pkgs upgrade  # 3rd time
    ```

- Then try `sudo apt-get upgrade` again (4th time). Now there shouldn't be
  any "kept back packages" anymore. However you could still see some "no
  longer required" packages:
    ```
    ...
    The following packages were automatically installed and are no longer required:
      linux-headers-4.15.0-136 linux-headers-4.15.0-136-generic
    Use 'sudo apt autoremove' to remove them.
    0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
    ```
  in which case just use the suggested command:
    ```
    sudo apt autoremove
    ```

- Then try `sudo apt-get upgrade` for the last time (5th time) and you should
  see something like this:
    ```
    Reading package lists... Done
    Building dependency tree
    Reading state information... Done
    Calculating upgrade... Done
    0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
    ```
  which indicates that everything is up-to-date.

- Finally you can reboot with:
    ```
    sudo reboot
    ```


### 1.5 Check locales

The following command:

    cat /etc/default/locale

should display:

    #  File generated by update-locale
    LANG="en_US.UTF-8"

Note that with the above setting (`LANG="en_US.UTF-8"`), and if the `LC_TIME`
variable is not defined in the `/etc/default/locale` file, the `date` command
prints the time in AM/PM format on Ubuntu 20.04:

    date
    # Tue Apr 20 04:25:04 PM EDT 2021

To change this to 24-hour format (which is highly recommended), set `LC_TIME`
to `en_GB` like this:

    sudo locale-gen "en_GB"
    sudo update-locale LC_TIME="en_GB"

Then logout and login again for the change to take effect, and try:

    date
    # Tue 20 Apr 16:26:10 EDT 2021


### 1.6 Create the biocbuild account

    sudo adduser biocbuild

This should be set up as a regular account. In particular it should NOT have
sudo privileges.

Login as biocbuild and install the following SSH keys (in the `~biocbuild/.ssh`
folder):
- biocbuild private and public keys (`id_rsa` and `id_rsa.pub` files)
- devteam member public keys (in `authorized_keys` file)

TESTING: Logout and try to login again as biocbuild. Then logout and login
again as before (sudoer account).


### 1.7 Run Xvfb as a service

Some Bioconductor packages like adSplit, GeneAnswers, or lmdme, contain
examples that need access to an X11 display. However, when running
`R CMD check` in the context of the daily builds, no X11 display is
available. This will cause the above packages to fail on the build report.
Here is the full list of packages affected by this (as of May 2021): adSplit,
clippda, DaMiRseq, fCI, GARS, GeneAnswers, lmdme, NormqPCR, OMICsPCA,
Rcade, tscR, and TTMap. Note that for some packages we will only see a
warning but for some others it will be an ERROR (either during the BUILD
or CHECK stage).

If R is already installed on the machine, an easy way to reproduce the
problem is with:

    /path/to/Rscript -e 'png("fig2.png", type="Xlib")'
    #Error in .External2(C_X11, paste0("png::", filename), g$width, g$height,  :
    #  unable to start device PNG
    #Calls: png
    #In addition: Warning message:
    #In png("fig2.png", type = "Xlib") :
    #  unable to open connection to X11 display ''
    #Execution halted

If the software builds are already set up, you can access the `Rscript`
command with:

    cd ~/bbs-3.14-bioc/
    R/bin/Rscript -e 'png("fig2.png", type="Xlib")'

Running Xvfb as a service addresses this problem.

#### Install Xvfb

    sudo apt-get install xvfb

#### Create /etc/init.d/xvfb

Create `/etc/init.d/xvfb` with the following content:

    #! /bin/sh
    ### BEGIN INIT INFO
    # Provides:          Xvfb
    # Required-Start:    $remote_fs $syslog
    # Required-Stop:     $remote_fs $syslog
    # Default-Start:     2 3 4 5
    # Default-Stop:      0 1 6
    # Short-Description: Loads X Virtual Frame Buffer
    # Description:       This file should be used to construct scripts to be
    #                    placed in /etc/init.d.
    #
    #                    A virtual X server is needed to non-interactively run
    #                    'R CMD build' and 'R CMD check on some BioC packages.
    #                    The DISPLAY variable is set in /etc/profile.d/xvfb.sh.
    ### END INIT INFO
    
    XVFB=/usr/bin/Xvfb
    XVFBARGS=":1 -screen 0 800x600x16"
    PIDFILE=/var/run/xvfb.pid
    case "$1" in
      start)
        echo -n "Starting virtual X frame buffer: Xvfb"
        start-stop-daemon --start --quiet --pidfile $PIDFILE --make-pidfile --background --exec $XVFB -- $XVFBARGS
        echo "."
        ;;
      stop)
        echo -n "Stopping virtual X frame buffer: Xvfb"
        start-stop-daemon --stop --quiet --pidfile $PIDFILE
        sleep 2
        rm -f $PIDFILE
        echo "."
        ;;
      restart)
        $0 stop
        $0 start
        ;;
      *)
        echo "Usage: /etc/init.d/xvfb {start|stop|restart}"
        exit 1
    esac
    
    exit 0

Change permissions on `/etc/init.d/xvfb`:

    sudo chmod 755 /etc/init.d/xvfb

Test the script:

    sudo /etc/init.d/xvfb start
    sudo /etc/init.d/xvfb restart
    sudo /etc/init.d/xvfb stop

#### Create runlevel symlinks from /etc/rc.d/ to /etc/init.d/xvfb

Install `init-system-helpers`:

    sudo apt-get install init-system-helpers

Create the symlinks:

    sudo update-rc.d xvfb defaults

You can see the new symlinks with:

    ls -al /etc/rc*.d/*xvfb

These symlinks make the application behave as a system service,
by starting when the device boots and stopping at shutdown, as
configured by `Default-Start` and `Default-Stop` in the header
of the `/etc/init.d/xvfb` script.

Check current status of the service with:

    service xvfb status

Start/restart/stop the service:

    sudo service xvfb start
    service xvfb status
    
    sudo service xvfb restart
    service xvfb status
    
    sudo service xvfb stop
    service xvfb status

Service will automatically restart after each reboot.

#### Set DISPLAY environment variable in /etc/profile.d/xvfb.sh

Create `/etc/profile.d/xvfb.sh` with the following content:

    ## Set DISPLAY environment variable for use with Xvfb.
    ## See /etc/init.d/xvfb for start / stop configuration.
    
    export DISPLAY=:1.0

Change permissions on `/etc/profile.d/xvfb.sh`:

    sudo chmod 644 /etc/profile.d/xvfb.sh

You'll need to logout and login again to see the `DISPLAY` variable in your
environment. For now `echo $DISPLAY` should show nothing.

#### Reboot

    sudo reboot

#### Testing

From the biocbuild account:

    service xvfb status  # should be up and running
    echo $DISPLAY        # :1.0
    /path/to/Rscript -e 'png("fig2.png", type="Xlib")'  # no more error!


### 1.8 Install Ubuntu/deb packages

Install with:

    sudo apt-get install <pkg1> <pkg2> <pkg3> ...

#### Always nice to have

    sudo apt-get install tree manpages-dev mlocate

Notes:
- `manpages-dev` provides the man pages for the C standard lib
- `mlocate` provides the 'locate' command

#### Packages required by the build system itself (BBS)

    sudo apt-get install python3-minimal python3-pip git

#### Packages required to compile R

Strictly required:

    sudo apt-get install build-essential \
                         gfortran \
                         libreadline-dev \
                         libx11-dev \
                         libxt-dev \
                         zlib1g-dev \
                         libbz2-dev \
                         liblzma-dev \
                         libpcre2-dev \
                         libcurl4-openssl-dev

Optional (still possible to compile R without these packages but some
capabilities will be missing):

    sudo apt-get install gobjc \
                         libpng-dev \
                         libjpeg-dev \
                         libtiff-dev \
                         libcairo2-dev \
                         libicu-dev \
                         tcl-dev \
                         tk-dev \
                         default-jdk

#### Packages needed to build vignettes and reference manuals

    sudo apt-get install texlive \
                         texlive-font-utils \
                         texlive-pstricks \
                         texlive-latex-extra \
                         texlive-fonts-extra \
                         texlive-bibtex-extra \
                         texlive-science \
                         texlive-luatex \
                         texlive-lang-european \
                         texi2html \
                         texinfo \
                         pandoc \
                         pandoc-citeproc \
                         biber
                         #ttf-mscorefonts-installer

Notes:
- `texlive-font-utils` is for epstopdf.
- `texlive-pstricks` provides `pstricks.sty`.
- `texlive-latex-extra` provides `fullpage.sty`.
- `texlive-fonts-extra` provides `incosolata.sty`.
- `texlive-bibtex-extra` provides `unsrturl.bst`.
- `texlive-science` provides `algorithm.sty`.
- `texlive-luatex` provides `luatex85.sty`.
- `texlive-lang-european` provides language definition files e.g. `swedish.ldf`.
- `pandoc` and `pandoc-citeproc` are needed by CRAN package knitr.

#### Packages needed to support extra fonts (e.g. Helvetica)

Some R code can fail with errors like:

    Error in grid.Call(C_stringMetric, as.graphicsAnnot(x$label)) :
      X11 font -adobe-helvetica-%s-%s-*-*-%d-*-*-*-*-*-*-*, face 1 at size 11 could not be loaded

This can be solved by installing the following packages:

    sudo apt-get install gsfonts-x11 \
                         xfonts-base \
                         xfonts-scalable \
                         xfonts-100dpi \
                         xfonts-75dpi \
                         t1-xfree86-nonfree \
                         ttf-xfree86-nonfree \
                         ttf-xfree86-nonfree-syriac

Note that a reboot is required to make the fix effective.

#### Packages needed by some CRAN and/or BioC packages

For CRAN packages:

    sudo apt-get install libglu1-mesa-dev \
                         librsvg2-dev \
                         libgmp-dev \
                         libssl-dev \
                         libsasl2-dev \
                         libxml2-dev \
                         libcurl4-openssl-dev \
                         mpi-default-dev \
                         libudunits2-dev \
                         libv8-dev \
                         libmpfr-dev \
                         libfftw3-dev \
                         libmysqlclient-dev \
                         libpq-dev \
                         libmagick++-dev \
                         libgeos-dev \
                         libproj-dev \
                         libgdal-dev \
                         libpoppler-cpp-dev \
                         libgtk2.0-dev \
                         libgit2-dev \
                         jags \
                         libprotobuf-dev \
                         protobuf-compiler \
                         libglpk-dev

Notes:
- Do NOT install `cwltool` (for Rcwl)! Install with `pip3` instead (see below).
- `libglu1-mesa-dev` is for rgl.
- `librsvg2-dev` is for rsvg.
- `libgmp-dev` is for gmp.
- `libssl-dev` is for openssl and mongolite.
- `libsasl2-dev` is for mongolite.
- `libxml2-dev` is for XML.
- `libcurl4-openssl-dev` is for RCurl and curl.
- `mpi-default-dev` is for Rmpi.
- `libudunits2-dev` is for units.
- `libv8-dev` is for V8.
- `libmpfr-dev` is for Rmpfr.
- `libfftw3-dev` is for fftw and fftwtools.
- `libmysqlclient-dev` is for RMySQL.
- `libpq-dev` is for RPostgreSQL and RPostgres.
- `libmagick++-dev` is for magick.
- `libgeos-dev` is for rgeos.
- `libproj-dev` is for proj4.
- `libgdal-dev` is for sf.
- `libpoppler-cpp-dev` is for pdftools.
- `libgtk2.0-dev` is for RGtk2.
- `libgit2-dev` is for gert.
- `jags` is for rjags.
- `libprotobuf-dev` and `protobuf-compiler` are for protolite.
- `libglpk-dev` is for glpkAPI and to compile igraph with GLPK support.

For BioC packages:

    sudo apt-get install graphviz \
                         libgraphviz-dev \
                         libgtkmm-2.4-dev \
                         libgsl-dev \
                         libsbml5-dev \
                         automake \
                         libnetcdf-dev \
                         libopenbabel-dev \
                         libeigen3-dev \
                         clustalo \
                         ocl-icd-opencl-dev \
                         libavfilter-dev \
                         libfribidi-dev \
                         infernal \
                         fuse \
                         libfuse-dev \
                         kallisto

Notes:
- `graphviz` and `libgraphviz-dev` are for Rgraphviz.
- `libgtkmm-2.4-dev` is for HilbertVisGUI.
- `libgsl-dev` is for all the packages that depend on the GSL.
- `libsbml5-dev` is for rsbml.
- `automake` is for RProtoBufLib.
- `libnetcdf-dev` is for mzR, RNetCDF, etc...
- `libopenbabel-dev` and `libeigen3-dev` are for ChemmineOB.
- `clustalo` is for LowMACA.
- `ocl-icd-opencl-dev` is for gpuMagic.
- `libavfilter-dev` is for av/spatialHeatmap.
- `libfribidi-dev` is for CRAN package textshaping which BioC package
  EnhancedVolcano indirectly depends on via ragg and ggrastr.
- `infernal` is for inferrnal.
- `fuse` and `libfuse-dev` are for Travel.
- `kallisto` is for rkal.


### 1.9 Install Python 3 modules

#### Python 3 modules needed by the Single Package Builder only

`virtualenv` is used by the Single Package Builder. Despite python3 shipping
with `venv`, `venv` is not sufficient. The SPB must use `virtualenv`.

    sudo -H pip3 install virtualenv

#### Python 3 modules needed by some CRAN/Bioconductor packages

Some CRAN/Bioconductor packages interact with Python 3 and use Python
modules. Note that we deliberately install the modules _system wide_
(with `sudo -H pip3 install <module>`). This will make them available to
_all the builds_, independently of which account they will run from (e.g.
biocbuild for BBS or pkgbuild for the Single Package Builder). Since we
only install _trusted_ modules, this should not be a security concern. See
https://askubuntu.com/questions/802544/is-sudo-pip-install-still-a-broken-practice)

    sudo -H pip3 install numpy scipy sklearn h5py pandas mofapy mofapy2
    sudo -H pip3 install testresources tensorflow tensorflow_probability
    sudo -H pip3 install h5pyd
    sudo -H pip3 install cwltool
    sudo -H pip3 install nbconvert jupyter
    sudo -H pip3 install matplotlib phate

Notes:

- `scipy` is needed by Bioconductor packages MOFA and MOFA2, but also by
  the `sklearn` module (when `sklearn` is imported and `scipy` is not present,
  the former breaks). However, for some reason, `sudo -H pip3 install sklearn`
  does not install `scipy` and completes successfully even if `scipy` is
  not installed.

- `numpy`, `sklearn`, `h5py`, and `pandas` are needed by Bioconductor packages
  BiocSklearn, MOFA and MOFA2, and `numpy` is also needed by Bioconductor
  package DChIPRep.

- `mofapy` and `mofapy2` are needed by Bioconductor packages MOFA and MOFA2,
  respectively.

- `tensorflow` is needed by Bioconductor packages scAlign, netReg, and
  DeepPINCS. Note that trying to load the module in a Python 3 session might
  raise the following error:
    ```
    >>> import tensorflow
    2020-08-08 16:52:56.617223: W tensorflow/stream_executor/platform/default/dso_loader.cc:59] Could not load dynamic library 'libcudart.so.10.1'; dlerror: libcudart.so.10.1: cannot open shared object file: No such file or directory
    2020-08-08 16:52:56.617255: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
    ```
  Even though the message says that the error can be ignored, you can get rid
  of it by installing the libcudart10.1 package:
    ```
    sudo apt-get install libcudart10.1
    ```

- `tensorflow_probability` is needed by Bioconductor package netReg.

- `h5pyd` is needed by Bioconductor package rhdf5client.

- `cwltool` is needed by Bioconductor package Rcwl.

- `nbconvert` and `jupyter` are needed by CRAN package nbconvertR which is
  itself used by Bioconductor package destiny. Note that `jupyter --version`
  should display something like this (as of Jan. 2021):
    ```
    hpages@nebbiolo2:~$ jupyter --version
    jupyter core     : 4.7.1
    jupyter-notebook : 6.3.0
    qtconsole        : 5.1.0
    ipython          : 7.23.0
    ipykernel        : 5.5.3
    jupyter client   : 6.1.12
    jupyter lab      : not installed
    nbconvert        : 6.0.7
    ipywidgets       : 7.6.3
    nbformat         : 5.1.3
    traitlets        : 5.0.5
    ```
  It's ok if jupyter lab is not installed but everything else should be.

- `matplotlib` and `phate` are needed by CRAN package phateR which is itself
  used by Bioconductor package phemd.

TESTING: From Python (start it with `python3`), check `tensorflow` version
with:

    import tensorflow
    tensorflow.version.VERSION  # should be 2.x.y


### 1.10 Run Apache server as a service

Required only for a standalone or central builder.

Install Apache server:

    sudo apt-get install apache2

Start it:

    sudo service apache2 start

Check its status:

    service apache2 status

Service will automatically restart after each reboot.


### 1.11 Logout and login again as biocbuild

Almost everything in the next section must be done from the biocbuild account.



## 2. Set up the Bioconductor software builds


### 2.1 Set Apache server DocumentRoot

Required only for a standalone or central builder.

Create `/home/biocbuild/public_html/BBS` from the biocbuild account:

    cd
    mkdir -p public_html/BBS

Then edit `/etc/apache2/sites-enabled/000-default.conf` **from a sudoer
account**. First make a copy of the original file:

    cd /etc/apache2/sites-enabled/
    sudo cp -i 000-default.conf 000-default.conf.original

and make the following changes:

- Set `DocumentRoot` to `/home/biocbuild/public_html`

- Add the following lines at the bottom of the `VirtualHost` section:
    ```
    <VirtualHost *:80>
        ...

        # Add the 5 lines below.
        <Directory /home/biocbuild/public_html/>
                Options Indexes FollowSymLinks
                AllowOverride None
                Require all granted
        </Directory>

    </VirtualHost>
    ```

Restart the Apache server:

    sudo service apache2 restart

TESTING: From any account on the machine, you should be able to do:

    # Should print index of /home/biocbuild/public_html/BBS in HTML form:
    curl http://localhost/BBS/



### 2.2 Check connectivity with central builder

Needed only if the machine is being configured as a secondary build node.

Must be done from the biocbuild account.

#### Check that you can ping the central builder

Depending on whether the node you're ping'ing from is within RPCI's DMZ
or not, use the central builder's short or long (i.e. hostname+domain)
hostname. For example:

    ping malbec2                                   # from within RPCI's DMZ
    ping malbec2.bioconductor.org                  # from anywhere else

#### Install biocbuild RSA private key

Copy biocbuild RSA private key to `~biocbuild/.ssh/id_rsa` (e.g. copy it from
another build machine). Then `chmod 400 ~/.ssh/id_rsa` so permissions look
like this:

    biocbuild@nebbiolo2:~$ ls -l .ssh/id_rsa
    -r-------- 1 biocbuild biocbuild 1679 Apr 30 15:20 .ssh/id_rsa

#### Check that you can ssh to the central builder

    ssh malbec2                   # from within RPCI's DMZ
    ssh malbec2.bioconductor.org  # from anywhere else

If this is blocked by RPCI's firewall, after a while you'll get:

    ssh: connect to host malbec2.bioconductor.org port 22: Connection timed out

Contact the IT folks at RPCI if that's the case:

    Radomski, Matthew <Matthew.Radomski@RoswellPark.org>
    Landsiedel, Timothy <tjlandsi@RoswellPark.org>

#### Check that you can send HTTPS requests to the central builder

    curl https://malbec2                           # from within RPCI's DMZ
    curl https://malbec2.bioconductor.org          # from anywhere else

If this is blocked by RPCI's firewall, after a while you'll get:

    curl: (35) OpenSSL SSL_connect: SSL_ERROR_SYSCALL in connection to malbec2.bioconductor.org:443

Contact the IT folks at RPCI if that's the case (see above).

More details on https implementation in `BBS/README.md`.


### 2.3 Clone BBS git tree and create bbs-X.Y-bioc directory structure

Must be done from the biocbuild account.

#### Clone BBS git tree

    cd
    git clone https://github.com/bioconductor/BBS

#### Edit non_target_repos.txt

Only if we are a few weeks before the next Bioconductor release (Spring or
Fall) and you are setting up the **future devel builds**.

In this case you are setting up builds for a version of Bioconductor
that doesn't exist yet. This means that the public package repositories
for this version of Bioconductor (i.e. the package repos under
https://bioconductor.org/packages/) don't exist yet either (or if they do,
they're probably empty).

If this is the case, then `~/BBS/X.Y/bioc/non_target_repos.txt` needs to
be temporarily modified to point to current devel repositories.

For example, if we are a few weeks before the BioC 3.13 release,
and you are setting up the future BioC 3.14 builds, then you need to
make the following change to `~/BBS/3.14/bioc/non_target_repos.txt`:
**replace every occurences of `BBS_BIOC_VERSION` with 3.13**.

The modified file should look like this:

    https://bioconductor.org/packages/3.13/data/annotation
    https://bioconductor.org/packages/3.13/data/experiment
    https://bioconductor.org/packages/3.13/workflows
    https://bioconductor.org/packages/3.13/books

The reason we need to do this is for the build system to be able to find and
install all the dependencies of the software packages (BBS doesn't and cannot
use `BiocManager::install()` for that).

Note that the change is only temporary (don't commit it!), until the 3.14
public repos exist and get populated.

#### Create bbs-X.Y-bioc directory structure

For example, for the BioC 3.14 software builds:

    cd
    mkdir bbs-3.14-bioc
    cd bbs-3.14-bioc/
    mkdir rdownloads log


### 2.4 Install R

Must be done from the biocbuild account.

Note that we always build R **from source** on a Linux builder. We do not
install a package for a Linux distribution (i.e. we don't use `apt-get`
on Ubuntu).

#### Get R source tarball from CRAN

Move to the directory where we're going to download and extract the R source
tarball from CRAN:

    cd ~/bbs-3.14-bioc/rdownloads/

The exact tarball to download depends on whether we're configuring builds
for BioC release or devel. Remember that each version of Bioconductor is
tight to a given version of R e.g. BioC 3.11 & BioC 3.12 are tight to R 4.0,
BioC 3.13 & BioC 3.14 will be tight to R 4.1, etc... The reason two consecutive
versions of Bioconductor are tight to the same version of R is because R has
one major release per year (every Spring) and Bioconductor has two (one in
Spring and one in Fall). This is key to understand the following:

- The latest BioC release always uses the latest release of R. The source
  tarball for the latest release of R is normally available on the CRAN home
  page at: https://cran.r-project.org/
  So if you are installing/updating R for the release builds, use that.

- For BioC devel it depends:
  * The BioC devel cycle that runs from Spring to Fall uses the same R
    as the current BioC release.
  * The BioC devel cycle that runs from Fall to Spring uses R devel.
    So in this case you need to pick up the latest daily snapshot of
    R devel [available here](https://stat.ethz.ch/R/daily/), or,
    if we're close to the release of the next major version of R,
    pick up the latest daily snapshot of R alpha/beta/RC
    [available here](https://cran.r-project.org/src/base-prerelease/).

IMPORTANT NOTE: If we are only a few weeks before the Spring release of
Bioconductor and you are setting up the **future devel builds** (i.e.
builds for the upcoming Spring-to-Fall devel cycle), then you need to pick
up the same R that you would pick up for the devel builds. For example, if
we are a few weeks before the BioC 3.13 release, and you are setting up
the future BioC 3.14 builds, then you need to pick up the latest daily
snapshot of R alpha/beta/RC.

Note that the source tarball you download should have a unique and descriptive
name, including a version and/or a date, such as `R-3.2.r67960.tar.gz`,
`R-3.2-2015-10-26.tar.gz`, or `R-alpha_2021-04-28_r80240.tar.gz`. If it does
not have such a name (e.g. it's just called `R-devel.tar.gz`) please rename
it after downloading and before extracting.

#### Extract the source tarball

    tar zxvf R-alpha_2021-04-28_r80240.tar.gz

If the directory created by untarring is called something like `R-devel`
or `R-alpha`, we should rename it to a unique and descriptive name that
contains an svn revision number or a date e.g. to something like `R-4.1.r80240`
or `R-4.1-2021-04-28`.

Check version and revision with:

    cat R-alpha/VERSION
    cat R-alpha/SVN-REVISION

#### Configure and compile R

    cd ~/bbs-3.14-bioc/
    mkdir R         # preceded by 'rm -rf R.old && mv R R.old' if updating R
    cd R/
    ../rdownloads/R-4.1.r80240/configure --enable-R-shlib
    make -j10       # or 'make -j' to use all cores

Note: Using the `-j` option allows `make` to run in parallel. The nb following
the option specifies the nb of jobs to run simultaneously. See `man make` for
the details. Don't try to use a nb of jobs that is more than the nb of logical
cores available on the machine. It might still work but it won't be optimal (it
might actually slow things down). To get the nb of logical cores on a Linux
system:

    cat /proc/cpuinfo | grep processor | wc -l

#### After compilation

Do NOT run `make install`!

Run the `R-fix-flags.sh` script to modify the compiler flags that will be used
during package compilation. The script will modify `R/etc/Makeconf`. It's
important to run this from the `~/bbs-3.14-bioc/R/etc/` directory and not one
level up. Both locations contain `Makeconf` files but we only want to modify
the `Makeconf` file located in `~/bbs-3.14-bioc/R/etc/`:

    cd etc/
    ~/BBS/utils/R-fix-flags.sh

The script adds the `-Wall` flag to the compilation commands that will be used
to compile package native code (i.e. C/C++/Fortran code). The flag tells the
compiler to display additional warnings that can help package maintainers find
potential problems in their code. These warnings will be included in the HTML
report that gets generated at the end of the builds.

#### Basic testing

Start R:

    cd ~/bbs-3.14-bioc/
    R/bin/R         # check version displayed by startup message

Then from R:

    # --- check capabilities ---

    capabilities()  # all should be TRUE except aqua and profmem
    X11()           # nothing visible should happen

    # --- install a few CRAN packages ---

    # with C++ code:
    install.packages("Rcpp", repos="https://cran.r-project.org")
    # with Fortran code:
    install.packages("minqa", repos="https://cran.r-project.org")
    # a possibly difficult package:
    install.packages("rJava", repos="https://cran.r-project.org")
    # another possibly difficult package:
    install.packages("RGtk2", repos="https://cran.r-project.org")

#### Install BiocManager + BiocCheck

From R:

    install.packages("BiocManager", repos="https://cran.r-project.org")

    library(BiocManager)  # This displays the version of Bioconductor
                          # that BiocManager is pointing at.

    ## IMPORTANT: Switch to "devel" **ONLY** if you are installing R for
    ## the devel builds and if BioC devel uses the same version of R as
    ## BioC release!
    BiocManager::install(version="devel")

    BiocManager::install("BiocCheck")    # required by SPB

#### [OPTIONAL] More testing

From R:

    # always good to have:
    install.packages("devtools", repos="https://cran.r-project.org")
    BiocManager::install("BiocStyle")

    BiocManager::install("rtracklayer")
    BiocManager::install("VariantAnnotation")
    BiocManager::install("rhdf5")

#### [OPTIONAL] Flush the data caches

When R is updated, it's a good time to flush the cache for AnnotationHub,
ExperimentHub, and BiocFileCache. This is done by removing the corresponding
folders present in `~/.cache/`.

Removing these folders means all packages using these resources will have
to re-download the files. This ensures that resources are still available.
However it also contributes to an increased runtime for the builds.

Should we also remove package specific caches?


### 2.5 Add software builds to biocbuild's crontab

Must be done from the biocbuild account.

First make sure to have the following lines at the top of the crontab:

    USER=biocbuild
    
    # By default, PATH is set to /usr/bin:/bin only. We need /usr/local/bin
    # for things that we install locally (e.g. new versions of pandoc).
    # It must be placed **before** /usr/bin.
    PATH=/usr/local/bin:/usr/bin:/bin

Then add the following entries to the crontab:

    # BIOC 3.14 SOFTWARE BUILDS
    # -------------------------

    # prerun:
    50 14 * * 0-5 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/bioc/`hostname` && ./prerun.sh >>/home/biocbuild/bbs-3.14-bioc/log/`hostname`-`date +\%Y\%m\%d`-prerun.log 2>&1'

    # run:
    00 16 * * 0-5 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/bioc/`hostname` && ./run.sh >>/home/biocbuild/bbs-3.14-bioc/log/`hostname`-`date +\%Y\%m\%d`-run.log 2>&1'

    # postrun (make sure this starts AFTER 'biocbuild' has finished its "run.sh"
    # job on ALL the nodes):
    00 12 * * 1-6 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/bioc/`hostname` && ./postrun.sh >>/home/biocbuild/bbs-3.14-bioc/log/`hostname`-`date +\%Y\%m\%d`-postrun.log 2>&1'

Now you can proceed to the next section or wait for a complete build run
before doing so (great time to catch up on your favorite Netflix show and
relax).



## 3. Install additional stuff for Bioconductor packages with special needs


Everything in this section must be done **from a sudoer account**.


### 3.1 Install BibTeX style humannat.bst

Required by Bioconductor package destiny.

Used to be part of earlier Ubuntu versions (in texlive-bibtex-extra) but
doesn't seem to be here anymore in Ubuntu 20.04.

Install with:

    cd /usr/share/texlive/texmf-dist/bibtex/bst/
    sudo mkdir beebe
    cd beebe/
    sudo wget https://ctan.org/tex-archive/biblio/bibtex/contrib/misc/humannat.bst
    sudo texhash


### 3.2 Install ensembl-vep

Required by Bioconductor packages ensemblVEP and MMAPPR2.

Complete installation instructions are at
https://www.ensembl.org/info/docs/tools/vep/script/vep_download.html

#### Install Perl modules

According to ensembl-vep README, the following Perl modules are required:

    ## Needed by both ensemblVEP and MMAPPR2:
    sudo cpan install Archive::Zip
    sudo cpan install File::Copy::Recursive
    sudo cpan install DBI
    sudo cpan install DBD::mysql  # MySQL client needed!
    
    ## Needed by MMAPPR2 only:
    sudo cpan install -f XML::DOM::XPath  # -f to force install despite tests failing
    sudo cpan install IO::String
    sudo cpan install Bio::SeqFeature::Lite  # takes a while...

Install `libhts-dev` and create some symlinks (needed for Tabix Perl module):

    sudo apt-get install libhts-dev
    cd /usr/lib/
    sudo ln -s x86_64-linux-gnu/libhts.so
    sudo ln -s x86_64-linux-gnu/libhts.a

Then:

    sudo cpan install Bio::DB::HTS::Tabix

#### Install ensembl-vep

    cd /usr/local/
    sudo git clone https://github.com/Ensembl/ensembl-vep.git
    cd ensembl-vep/
    #sudo git checkout release/100  # select desired branch

    # Avoid the hassle of getting HTSlib to compile because ensemblVEP and
    # MMAPPR2 pass 'R CMD build' and 'R CMD check' without that and that's
    # all we care about.
    sudo perl INSTALL.pl --NO_HTSLIB
    # When asked if you want to install any cache files - say no
    # When asked if you want to install any FASTA files - say no
    # When asked if you want to install any plugins - say no

#### Edit /etc/profile

In `/etc/profile` append `/usr/local/ensembl-vep` to `PATH`.
Note that the `/etc/profile` file has read-only permissions (factory
settings). To save changes you will need to force save, e.g., in the
`vi` editor this is `w!`.

Logout and login again for the changes to `/etc/profile` to take effect.

#### Testing

From the biocbuild account, try to build and check the ensemblVEP and
MMAPPR2 packages:

    cd ~/bbs-3.14-bioc/meat/

    ## Takes about 4 min. to build and 8 min. to check:
    ../R/bin/R CMD build ensemblVEP
    ../R/bin/R CMD check --no-vignettes ensemblVEP_X.Y.Z.tar.gz

    ## Takes about 2 min. to build and 4 min. to check:
    ../R/bin/R CMD build MMAPPR2
    ../R/bin/R CMD check --no-vignettes MMAPPR2_X.Y.Z.tar.gz


### 3.3 Install ViennaRNA

Required by Bioconductor package GeneGA.

#### Download and install

    ## No Ubuntu package for 20.04 yet (as of Aug. 2020) but the package for
    ## Ubuntu 19.04 seems to work alright.
    #wget https://www.tbi.univie.ac.at/RNA/download/ubuntu/ubuntu_19_04/viennarna_2.4.14-1_amd64.deb
    #sudo dpkg -i viennarna_2.4.14-1_amd64.deb

    ## There's one now! (Jan. 2021)
    wget https://www.tbi.univie.ac.at/RNA/download/ubuntu/ubuntu_20_04/viennarna_2.4.17-1_amd64.deb
    sudo dpkg -i viennarna_2.4.17-1_amd64.deb

#### Testing

From the biocbuild account:

    which RNAfold  # /usr/bin/RNAfold

Finally try to build the GeneGA package:

    cd ~/bbs-3.14-bioc/meat/
    ../R/bin/R CMD build GeneGA


### 3.4 Set LIBSBML_CFLAGS and LIBSBML_LIBS

Required by Bioconductor package rsbml.

Unfortunately `libsbml5-dev` doesn't include a pkg-config file (`libsbml.pc`)
so we need to define environment variables LIBSBML_CFLAGS and LIBSBML_LIBS
in order for rsbml to compile.

#### Edit /etc/profile

In `/etc/profile` add:

    export LIBSBML_CFLAGS="-I/usr/include"
    export LIBSBML_LIBS="-lsbml"

Logout and login again for the changes to `/etc/profile` to take effect.

#### Testing

From the biocbuild account:

    cd ~/bbs-3.14-bioc/meat/
    ../R/bin/R CMD INSTALL rsbml


### 3.5 Install ImmuneSpace credentials

Required by Bioconductor package ImmuneSpaceR.

#### Edit /etc/profile

In `/etc/profile` add:

    export ISR_login=bioc@immunespace.org
    export ISR_pwd=1notCRAN

Logout and login again for the changes to `/etc/profile` to take effect.

#### Testing

From the biocbuild account:

    cd ~/bbs-3.14-bioc/meat/
    ../R/bin/R CMD build ImmuneSpaceR


### 3.6 Install Perl module XML::Simple

Required by Bioconductor package LowMACA.

#### Install

    sudo cpan install XML::Simple

#### Testing

From the biocbuild account:

    cd ~/bbs-3.14-bioc/meat/
    ../R/bin/R CMD build LowMACA


### 3.7 Install ROOT

SEPT 2020: THIS SHOULD NO LONGER BE NEEDED! (xps was deprecated in BioC 3.12)

Required by Bioconductor package xps.

xps wants ROOT 5, not 6.

ROOT supports 2 installation methods: "location independent" and "fix
location". We will do "location independent" installation.

#### Prerequisite

    sudo apt-get install cmake
    sudo apt-get install libxpm-dev

#### Build

    cd ~/sandbox/
    ## Unfortunately ROOT v5-34-00 fails to compile on Ubuntu 20.04 so
    ## we install ROOT v6-22-00 (current stable release as of July 2020).
    ## We know that xps wants ROOT 5, not 6, so even though compiling
    ## ROOT v6-22-00 is succesful we kind of anticipate bad things to
    ## happen later.
    #git clone --branch v5-34-00-patches https://github.com/root-project/root.git root_src
    git clone --branch v6-22-00-patches https://github.com/root-project/root.git root_src
    mkdir root_build
    cd root_build/
    cmake -DCMAKE_INSTALL_PREFIX=/usr/local/root -Dgnuinstall=ON -Dfortran=OFF -Dmysql=OFF -Dsqlite=OFF ../root_src
    cmake --build . -- -j20  # takes about 10 min.

#### Install

    sudo cmake --build . --target install

Try to start a ROOT interactive session:

    source bin/thisroot.sh
    root  # then quit the session with .q

#### Edit /etc/profile

In `/etc/profile` add the following line (before the `PATH` and
`DYLD_LIBRARY_PATH` lines):

    export ROOTSYS="/usr/local/root"  # do NOT set ROOTSYS, it will break
                                      # xps configure script!

Also append `$ROOTSYS/bin` to `PATH` and `$ROOTSYS/lib/root` to
`DYLD_LIBRARY_PATH`.

#### Testing

From the biocbuild account:

    which root-config      # /usr/local/root/bin/root-config
    root-config --version  # 6.22/01

Finally try to install the xps package:

    cd ~/bbs-3.14-bioc/meat/
    ../R/bin/R CMD INSTALL xps

As expected, this currently fails (with xps 1.49.0):

    * installing to library ‘/home/biocbuild/bbs-3.12-bioc/R/library’
    * installing *source* package ‘xps’ ...
    ** using staged installation
    checking for gcc... gcc
    checking for C compiler default output file name... a.out
    checking whether the C compiler works... yes
    checking whether we are cross compiling... no
    checking for suffix of executables...
    checking for suffix of object files... o
    checking whether we are using the GNU C compiler... yes
    checking whether gcc accepts -g... yes
    checking for gcc option to accept ANSI C... none needed
    checking how to run the C preprocessor... gcc -E
    checking for gcc... (cached) gcc
    checking whether we are using the GNU C compiler... (cached) yes
    checking whether gcc accepts -g... (cached) yes
    checking for gcc option to accept ANSI C... (cached) none needed
    found ROOT version 6.22/01 in directory /usr/local/root
    ** libs
    ** arch -
    Unknown argument "--dicttype"!
    Usage: root-config [--prefix[=DIR]] [--exec-prefix[=DIR]] [--version] [--cflags] [--auxcflags] [--ldflags] [--new] [--nonew] [--libs] [--glibs] [--evelibs] [--bindir] [--libdir] [--incdir] [--etcdir] [--tutdir] [--srcdir] [--noauxcflags] [--noauxlibs] [--noldflags] [--has-<feature>] [--arch][--python-version] [--python2-version] [--python3-version] [--cc] [--cxx] [--f77] [--ld ] [--help]
    c++ -I/usr/local/root/include -O2 -Wall -fPIC -pthread -std=c++11 -m64 -I/usr/local/root/include/root -c TMLMath.cxx
    TMLMath.cxx:1111: warning: "xmax" redefined
     1111 | #define xmax  2.5327372760800758e+305
          |
    ...
    ...
    c++ -I/usr/local/root/include -O2 -Wall -fPIC -pthread -std=c++11 -m64 -I/usr/local/root/include/root -c rwrapper.cxx
    Generating dictionary xpsDict.cxx...
    rootcint: error while loading shared libraries: libRIO.so: cannot open shared object file: No such file or directory
    make: *** [Makefile:112: xpsDict.cxx] Error 127
    ERROR: compilation failed for package ‘xps’
    * removing ‘/home/biocbuild/bbs-3.12-bioc/R/library/xps’



## 4. Set up other builds


### 4.1 Annotation builds


### 4.2 Experimental data builds

From the biocbuild account:

    mkdir -p ~/bbs-3.14-data-experiment/log

Then add the following entries to biocbuild's crontab:

    # BIOC 3.14 DATA EXPERIMENT BUILDS
    # --------------------------------
    # run on Mondays and Thursdays
    
    # prerun:
    00 09 * * 1,4 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/data-experiment/`hostname` && ./prerun.sh >>/home/biocbuild/bbs-3.14-data-experiment/log/`hostname`-`date +\%Y\%m\%d`-prerun.log 2>&1'
    
    # run:
    25 09 * * 1,4 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/data-experiment/`hostname` && ./run.sh >>/home/biocbuild/bbs-3.14-data-experiment/log/`hostname`-`date +\%Y\%m\%d`-run.log 2>&1'
    
    # postrun (this should start AFTER builds are finished on all nodes):
    45 15 * * 1,4 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/data-experiment/`hostname` && ./postrun.sh >>/home/biocbuild/bbs-3.14-data-experiment/log/`hostname`-`date +\%Y\%m\%d`-postrun.log 2>&1'


### 4.3 Workflows builds

From the biocbuild account:

    mkdir -p ~/bbs-3.14-workflows/log

Then add the following entries to biocbuild's crontab:

    # BIOC 3.14 WORKFLOWS BUILDS
    # --------------------------
    # run on Tuesdays and Fridays
    
    # prerun:
    00 09 * * 2,5 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/workflows/`hostname` && ./prerun.sh >>/home/biocbuild/bbs-3.14-workflows/log/`hostname`-`date +\%Y\%m\%d`-prerun.log 2>&1'
    
    # run:
    05 09 * * 2,5 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/workflows/`hostname` && ./run.sh >>/home/biocbuild/bbs-3.14-workflows/log/`hostname`-`date +\%Y\%m\%d`-run.log 2>&1'
    
    # postrun (this should start AFTER builds are finished on all nodes):
    45 15 * * 2,5 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/workflows/`hostname` && ./postrun.sh >>/home/biocbuild/bbs-3.14-workflows/log/`hostname`-`date +\%Y\%m\%d`-postrun.log 2>&1'


### 4.4 Books builds

From the biocbuild account:

    mkdir -p ~/bbs-3.14-books/log

Then add the following entries to biocbuild's crontab:

    # BIOC 3.14 BOOKS BUILDS
    # ----------------------
    # run on Tuesdays and Fridays

    # prerun:
    00 09 * * 2,5 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/books/`hostname` && ./prerun.sh >>/home/biocbuild/bbs-3.14-books/log/`hostname`-`date +\%Y\%m\%d`-prerun.log 2>&1'

    # run (start after the workflows builds to avoid concurrent INSTALLs and
    # competing for resources):
    30 10 * * 2,5 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/books/`hostname` && ./run.sh >>/home/biocbuild/bbs-3.14-books/log/`hostname`-`date +\%Y\%m\%d`-run.log 2>&1'

    # postrun (this should start AFTER builds are finished on all nodes):
    45 17 * * 2,5 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/books/`hostname` && ./postrun.sh >>/home/biocbuild/bbs-3.14-books/log/`hostname`-`date +\%Y\%m\%d`-postrun.log 2>&1'


### 4.5 Long Tests builds

From the biocbuild account:

    mkdir -p ~/bbs-3.14-bioc-longtests/log

Then add the following entries to biocbuild's crontab:

    # BIOC 3.14 SOFTWARE LONGTESTS BUILDS
    # -----------------------------------
    # run every Saturday

    # prerun:
    00 09 * * 6 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/bioc-longtests/`hostname` && ./prerun.sh >>/home/biocbuild/bbs-3.14-bioc-longtests/log/`hostname`-`date +\%Y\%m\%d`-prerun.log 2>&1'

    # run:
    30 09 * * 6 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/bioc-longtests/`hostname` && ./run.sh >>/home/biocbuild/bbs-3.14-bioc-longtests/log/`hostname`-`date +\%Y\%m\%d`-run.log 2>&1'

    # postrun (this should start AFTER builds are finished on all nodes):
    30 17 * * 6 /bin/bash --login -c 'cd /home/biocbuild/BBS/3.14/bioc-longtests/`hostname` && ./postrun.sh >>/home/biocbuild/bbs-3.14-bioc-longtests/log/`hostname`-`date +\%Y\%m\%d`-postrun.log 2>&1'

